#{extends 'main.html' /}
#{set 'title'}
Tableau asynchrone
#{/set}

<P>Exemple avec Play! 1.1, utilisation du long-polling<br/> et de la partie NIO asynchrone de Play!</P>

#{set 'moreScripts'}

<script type="text/javascript" src="@{'/public/javascripts/jquery-1.4.4.min.js'}"></script>
<script type="text/javascript" src="@{'/public/javascripts/jquery-ui-1.8.11.custom.min.js'}"></script>

#{/set}


<table class="simpleTable">
    <thead>
    <tr>
        <td>id</td>
        <td>var 1</td>
        <td>var 2</td>
        <td>last update</td>
    </tr>
    </thead>
    #{list items:listOfData, as:'m'}
    <tr id="row_${m.id}">
        <td id="id_${m.id}">${m.id}</td>
        <td id="p1_${m.id}">${m.variable01.round(3)}</td>
        <td id="p2_${m.id}">${m.variable02.round(3)}</td>
        <td id="date_${m.id}">${m.date.format('DD MMM yyyy HH:mm:ss')}</td>
    </tr>
    #{/list}
</table>
<div id="newMessage">
    <input type="button" value="Shuffle values" id="send" class="button red"/>
</div>

<div id="asyncBlotter">
<P>Mettre Ã  jour une ligne :</P>
#{form @AsyncBlotter.updateLine()}
<input type="text" name="id" value="1" size="4"/>
<input type="text" name="variable01" value="3.0" size="5"/>
<input type="text" name="variable02" value="5.2" size="5"/>
<input type="submit" class="button green" value="Update"/>
#{/form}
</div>

<script type="text/javascript">

    $('#send').click(function(e) {
        $.get('@{index()}');
    });

//       $.ajaxSetup({
//      "error":function(info) {
//        //reset state here;
//          alert("Error JSON, the message is not valid "+info.status);
//    }});

    // Retrieve new messages
	var getMessages = function() {
      	$.ajax({
			url: '/asyncblotter/getmessages',
            success: function(json) {
					display(json);
			},
			complete: function() {
                getMessages();
			},
			dataType: 'json'
		});
	}

     var display = function(json){
         $.each(json, function(i, lineFromDB) {
                     $('#id_'+lineFromDB.id).text(lineFromDB.id);
                     $('#p1_'+lineFromDB.id).text(lineFromDB.variable01);
                     $('#p2_'+lineFromDB.id).text(lineFromDB.variable02);
                     $('#date_'+lineFromDB.id).text(lineFromDB.date);
                     $('#row_'+lineFromDB.id).effect('highlight',{color:'#f00'},200);
         });
     }

     getMessages();

</script>
